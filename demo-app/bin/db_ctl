#!/bin/bash

# root
source ~/.profile

if [ -n "$1" ] && [ "$1" = "-c" ]; then
	if [ -n "$MYSQL_FLAG" ] && [ "$MYSQL_FLAG" = "true" ]; then
		exit 0	
	fi		
fi

read -p "Enter MySQL root domain: " mysql_root_domain
read -s -p "Enter MySQL root password: " mysql_root_password

query="USE mysql; FLUSH PRIVILEGES; ALTER USER 'root'@'$mysql_root_domain' IDENTIFIED WITH mysql_native_password BY '$mysql_root_password';"

service mysql stop
mkdir -p /var/run/mysqld
chown mysql:mysql /var/run/mysqld/
mysqld_safe --skip-grant-tables &
sleep 5

mysql -u root -e "$query"
mysqladmin -u root -p"$mysql_root_password" shutdown
service mysql start

mysql -u root -p"$mysql_root_password" < ./sql/setup.sql

touch .env

sed -i '/DB_CONNECTION/d' .env
sed -i '/DB_HOST/d' .env
sed -i '/DB_PORT/d' .env
sed -i '/DB_DATABASE/d' .env
sed -i '/DB_USERNAME/d' .env
sed -i '/DB_PASSWORD/d' .env

echo "" >> .env
echo "DB_CONNECTION=mysql" >> .env
echo "DB_HOST=$mysql_root_domain" >> .env
echo "DB_PORT=3306" >> .env
echo "DB_DATABASE=demo_app" >> .env
echo "DB_USERNAME=root" >> .env
echo "DB_PASSWORD=$mysql_root_password" >> .env

# Remove existing declarations
sed -i '/export MYSQL_FLAG=/d' ~/.profile

# Set environment variables in ~/.bashrc
echo "export MYSQL_FLAG=\"true\"" >> ~/.profile

